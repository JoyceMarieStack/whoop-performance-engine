<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whoop Recovery Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="landing">

  <!-- Unauthenticated: Hero / landing section -->
  <main id="hero" class="hero">
    <div class="hero-content">
      <h1 class="hero-title">Whoop Recovery<br><span class="accent">Dashboard</span></h1>
      <p class="hero-tagline">View your recovery score, HRV, and resting heart rate at a glance.</p>

      <div id="error-message" class="error-banner" style="display:none;"></div>

      <a href="/auth/whoop" class="btn btn-primary">Connect to Whoop</a>
    </div>
  </main>

  <!-- Authenticated: Dashboard section (hidden until auth confirmed) -->
  <div id="dashboard" style="display:none;">
    <header class="dashboard-header">
      <h1>Whoop <span class="accent">Recovery</span></h1>
    </header>

    <main class="dashboard-body">
      <!-- Loading state -->
      <div id="loading" class="loading-container" style="display:none;">
        <div class="spinner"></div>
        <p class="loading-text">Loading your recovery data…</p>
      </div>

      <!-- Metric cards (hidden until data loads) -->
      <div id="metrics" class="metric-grid" style="display:none;">
        <div id="card-recovery" class="metric-card">
          <p class="metric-label">Recovery Score</p>
          <p id="recovery-value" class="metric-value">—</p>
          <p class="metric-unit">%</p>
        </div>
        <div id="card-hrv" class="metric-card">
          <p class="metric-label">HRV</p>
          <p id="hrv-value" class="metric-value">—</p>
          <p class="metric-unit">ms (RMSSD)</p>
        </div>
        <div id="card-rhr" class="metric-card">
          <p class="metric-label">Resting Heart Rate</p>
          <p id="rhr-value" class="metric-value">—</p>
          <p class="metric-unit">bpm</p>
        </div>
      </div>

      <!-- Error state (hidden by default) -->
      <div id="error" class="state-message" style="display:none;">
        <h2 id="error-title">Something went wrong</h2>
        <p id="error-text">We couldn't load your recovery data. Please try again.</p>
        <button id="retry-btn" class="btn btn-secondary">Retry</button>
      </div>

      <!-- No-data state (hidden by default) -->
      <div id="no-data" class="state-message" style="display:none;">
        <h2>No Recovery Data Yet</h2>
        <p>Your recovery hasn't been scored yet. Check back after your next sleep is processed by Whoop.</p>
      </div>
    </main>
  </div>

  <noscript>
    <div class="error-banner" style="display:block;margin:2rem auto;max-width:480px;">
      JavaScript is required to use the Whoop Recovery Dashboard.
    </div>
  </noscript>

  <script>
    (function () {
      'use strict';

      // --- DOM references ---
      var heroEl = document.getElementById('hero');
      var dashboardEl = document.getElementById('dashboard');
      var loadingEl = document.getElementById('loading');
      var metricsEl = document.getElementById('metrics');
      var errorEl = document.getElementById('error');
      var noDataEl = document.getElementById('no-data');
      var retryBtn = document.getElementById('retry-btn');
      var errorBanner = document.getElementById('error-message');

      var recoveryValueEl = document.getElementById('recovery-value');
      var hrvValueEl = document.getElementById('hrv-value');
      var rhrValueEl = document.getElementById('rhr-value');
      var recoveryCard = document.getElementById('card-recovery');

      // --- Error banner from OAuth redirects (e.g., ?error=access_denied) ---
      var params = new URLSearchParams(window.location.search);
      var urlError = params.get('error');
      if (urlError) {
        var messages = {
          access_denied: 'Authorization was denied. Please try again to connect your Whoop account.',
          auth_failed: 'Authentication failed. Please try connecting again.',
          invalid_state: 'Security validation failed. Please try connecting again.',
        };
        errorBanner.textContent = messages[urlError] || 'An unexpected error occurred. Please try again.';
        errorBanner.style.display = 'block';
        window.history.replaceState({}, '', '/');
      }

      // --- State management ---

      /** Show only the specified dashboard state element, hide all others. */
      function showDashboardState(el) {
        loadingEl.style.display = 'none';
        metricsEl.style.display = 'none';
        errorEl.style.display = 'none';
        noDataEl.style.display = 'none';
        el.style.display = el === metricsEl ? 'grid' : 'flex';
      }

      /** Switch to authenticated (dashboard) view. */
      function showDashboard() {
        document.body.className = 'dashboard';
        heroEl.style.display = 'none';
        dashboardEl.style.display = 'block';
      }

      /** Switch to unauthenticated (hero) view. */
      function showHero() {
        document.body.className = 'landing';
        dashboardEl.style.display = 'none';
        heroEl.style.display = '';
      }

      /** Recovery score color: green 67–100, yellow 34–66, red 0–33. */
      function getRecoveryColorClass(score) {
        if (score >= 67) return 'recovery-green';
        if (score >= 34) return 'recovery-yellow';
        return 'recovery-red';
      }

      /** Render recovery metrics into the dashboard cards. */
      function renderMetrics(data) {
        if (data.recoveryScore !== null && data.recoveryScore !== undefined) {
          recoveryValueEl.textContent = Math.round(data.recoveryScore);
          recoveryCard.className = 'metric-card ' + getRecoveryColorClass(data.recoveryScore);
        } else {
          recoveryValueEl.textContent = '—';
          recoveryCard.className = 'metric-card';
        }

        if (data.hrvRmssdMilli !== null && data.hrvRmssdMilli !== undefined) {
          hrvValueEl.textContent = data.hrvRmssdMilli.toFixed(1);
        } else {
          hrvValueEl.textContent = '—';
        }

        if (data.restingHeartRate !== null && data.restingHeartRate !== undefined) {
          rhrValueEl.textContent = Math.round(data.restingHeartRate);
        } else {
          rhrValueEl.textContent = '—';
        }

        showDashboardState(metricsEl);
      }

      /** Display an error state with a custom title and message. */
      function showError(title, message) {
        document.getElementById('error-title').textContent = title;
        document.getElementById('error-text').textContent = message;
        showDashboardState(errorEl);
      }

      /** Fetch recovery data from the BFF API. */
      async function fetchRecovery() {
        showDashboardState(loadingEl);

        try {
          var response = await fetch('/api/recovery');

          // Auth expired — revert to hero with message
          if (response.status === 401) {
            showHero();
            errorBanner.textContent = 'Your session has expired. Please reconnect your Whoop account.';
            errorBanner.style.display = 'block';
            return;
          }

          // API error — show error with retry
          if (!response.ok) {
            var errData = await response.json().catch(function () { return {}; });
            showError(
              'Something went wrong',
              errData.message || "We couldn't load your recovery data. Please try again."
            );
            return;
          }

          var data = await response.json();

          // Handle PENDING_SCORE / UNSCORABLE — show no-data or partial data
          if (data.scoreState !== 'SCORED') {
            var hasPartialData =
              data.recoveryScore !== null ||
              data.hrvRmssdMilli !== null ||
              data.restingHeartRate !== null;

            if (hasPartialData) {
              renderMetrics(data);
            } else {
              showDashboardState(noDataEl);
            }
            return;
          }

          renderMetrics(data);
        } catch (err) {
          console.error('Recovery fetch error:', err);
          showError(
            'Connection Error',
            'Unable to reach the server. Please check your connection and try again.'
          );
        }
      }

      // --- Retry button ---
      retryBtn.addEventListener('click', fetchRecovery);

      // --- Init: check auth status and render appropriate view ---
      (async function init() {
        try {
          var statusRes = await fetch('/api/status');
          var status = await statusRes.json();

          if (status.authenticated) {
            showDashboard();
            fetchRecovery();
          }
          // else: hero is already visible by default
        } catch (err) {
          console.error('Status check error:', err);
          // Fail open — show hero (unauthenticated view)
        }
      })();
    })();
  </script>
</body>
</html>
